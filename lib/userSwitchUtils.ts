/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * 
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚¹ãƒˆã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹æ©Ÿèƒ½
 * v1.7.0: åŠ¹æœéŸ³ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã‚’å®Ÿç¾
 */

/**
 * å…¨ã‚¹ãƒˆã‚¢ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
 * @param userId ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆnullã®å ´åˆã¯å…¨ã¦ã‚¯ãƒªã‚¢ï¼‰
 */
export const clearAllUserData = async (userId: string | null = null) => {
  try {
    // ğŸ”¥ å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§å„ã‚¹ãƒˆã‚¢ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹ï¼‰
    
    // ã‚¿ã‚¹ã‚¯ã‚¹ãƒˆã‚¢ã®ã‚¯ãƒªã‚¢
    const { useEnhancedTaskStore } = await import('@/store/enhancedTaskStore');
    const taskStore = useEnhancedTaskStore.getState();
    taskStore.clearTasks();
    
    // ãƒã‚¤ãƒ³ãƒˆã‚¹ãƒˆã‚¢ã¯è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã€æ‰‹å‹•ã‚¯ãƒªã‚¢ä¸è¦
    
    // ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã‚¹ãƒˆã‚¢ã®ã‚¯ãƒªã‚¢
    const { useGameCenterStore } = await import('@/store/gameCenterStore');
    const gameStore = useGameCenterStore.getState();
    // ã‚²ãƒ¼ãƒ ã‚¹ãƒˆã‚¢ã«ã¯æ˜ç¤ºçš„ãªã‚¯ãƒªã‚¢æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯è‡ªå‹•çš„ã«ç©ºã«ãªã‚‹
    
    // ã‚·ãƒ§ãƒƒãƒ—ã‚¹ãƒˆã‚¢ã®ã‚¯ãƒªã‚¢
    const { useShopStore } = await import('@/store/shopStore');
    const shopStore = useShopStore.getState();
    // ã‚·ãƒ§ãƒƒãƒ—ã‚¹ãƒˆã‚¢ã‚‚è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã€æ‰‹å‹•ã‚¯ãƒªã‚¢ä¸è¦
    
    // ãƒ†ãƒ¼ãƒã‚¹ãƒˆã‚¢ã¯æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ãŒå®Ÿè£…æ¸ˆã¿
    
  } catch (error) {
    console.error('âŒ ã‚¹ãƒˆã‚¢ã‚¯ãƒªã‚¢å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
  }
};

/**
 * æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹
 * @param userId åˆæœŸåŒ–ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 */
export const initializeNewUserData = async (userId: string) => {
  console.log('æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–é–‹å§‹:', userId);
  
  try {
    // ãƒ†ãƒ¼ãƒã‚¹ãƒˆã‚¢ã®æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆæœŸåŒ–ã¯æ—¢ã« switchUser ã§å‡¦ç†æ¸ˆã¿
    console.log('âœ… ãƒ†ãƒ¼ãƒã®åˆæœŸåŒ–å®Œäº†');
    
    // ä»–ã®ã‚¹ãƒˆã‚¢ã‚‚å¿…è¦ã«å¿œã˜ã¦åˆæœŸåŒ–å‡¦ç†ã‚’è¿½åŠ 
    // ï¼ˆç¾åœ¨ã¯å„ã‚¹ãƒˆã‚¢ãŒè‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ä¸è¦ï¼‰
    
    console.log('âœ… æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
    
  } catch (error) {
    console.error('âŒ æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
  }
};

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å®Œå…¨ãªå‡¦ç†
 * @param oldUserId å‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 * @param newUserId æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 */
export const handleUserSwitch = async (oldUserId: string | null, newUserId: string | null) => {
  console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆå‡¦ç†é–‹å§‹:', { old: oldUserId, new: newUserId });
  
  // 1. å‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
  if (oldUserId) {
    await clearAllUserData(oldUserId);
  }
  
  // 2. æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
  if (newUserId) {
    await initializeNewUserData(newUserId);
  } else {
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã¯å…¨ã¦ã‚’ã‚¯ãƒªã‚¢
    await clearAllUserData(null);
  }
  
  console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
};